name: openapi-pr-verify

on:
  pull_request:
    branches:
      - main
      - develop
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
    paths:
      - "api/rest/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-openapi-changes:
    runs-on: ubuntu-latest

    outputs:
      specs_json: ${{ steps.filter_specs.outputs.specs_json }}

    steps:
      - name: Detect changed files under api/rest
        id: detect_files
        uses: alberto-gonzalez-es/github-actions/actions/util/detect-changes@v1
        with:
          path_prefix: api/rest/

      - name: Filter OpenAPI specs (openapi.yml|yaml)
        id: filter_specs
        env:
          FILES_JSON: ${{ steps.detect_files.outputs.files_json }}
        run: |
          set -e

          echo "FILES_JSON: ${FILES_JSON}"

          if [ -z "${FILES_JSON}" ] || [ "${FILES_JSON}" = "[]" ]; then
            echo "No changed files. specs_json will be []."
            echo "specs_json=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Filter only *openapi.yml / openapi.yaml
          SPECS_JSON=$(echo "${FILES_JSON}" | \
            jq -c '[ .[] | select(test("openapi\\.ya?ml$")) ]')

          echo "Filtered specs_json: ${SPECS_JSON}"
          echo "specs_json=${SPECS_JSON}" >> "$GITHUB_OUTPUT"

  validate-openapi:
    needs: detect-openapi-changes
    if: needs.detect-openapi-changes.outputs.specs_json != '' && needs.detect-openapi-changes.outputs.specs_json != '[]'
    runs-on: ubuntu-latest

    outputs:
      validation_has_errors: ${{ steps.validate.outputs.validation_has_errors }}
      validation_report_b64: ${{ steps.validate.outputs.validation_report_b64 }}

    steps:
      - name: Validate OpenAPI specs
        id: validate
        uses: alberto-gonzalez-es/github-actions/actions/openapi/validate@v1
        with:
          specs_json: ${{ needs.detect-openapi-changes.outputs.specs_json }}

  lint-openapi:
    needs: detect-openapi-changes
    if: needs.detect-openapi-changes.outputs.specs_json != '' && needs.detect-openapi-changes.outputs.specs_json != '[]'
    runs-on: ubuntu-latest

    outputs:
      lint_has_errors: ${{ steps.lint.outputs.lint_has_errors }}
      lint_report_b64: ${{ steps.lint.outputs.lint_report_b64 }}

    steps:
      - name: Lint OpenAPI specs with Spectral
        id: lint
        uses: alberto-gonzalez-es/github-actions/actions/openapi/lint@v1
        with:
          specs_json: ${{ needs.detect-openapi-changes.outputs.specs_json }}

  summarize-openapi-checks:
    needs:
      - validate-openapi
      - lint-openapi
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Build combined report
        run: |
          set -e

          VALIDATION_B64="${{ needs.validate-openapi.outputs.validation_report_b64 }}"
          LINT_B64="${{ needs.lint-openapi.outputs.lint_report_b64 }}"

          REPORT_FILE="openapi-combined-report.md"
          : > "${REPORT_FILE}"

          if [ -n "${VALIDATION_B64}" ]; then
            echo "## OpenAPI validation report" >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
            echo "${VALIDATION_B64}" | base64 -d >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
          fi

          if [ -n "${LINT_B64}" ]; then
            echo "## OpenAPI lint report (Spectral)" >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
            echo "${LINT_B64}" | base64 -d >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
          fi

          cat "${REPORT_FILE}"

      - name: Post PR comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'openapi-combined-report.md';

            if (!fs.existsSync(path)) {
              core.info('No report to post.');
              return;
            }

            const body = fs.readFileSync(path, 'utf8');
            const prNumber = context.payload.pull_request.number;

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: prNumber,
              body,
            });

      - name: Fail PR if validation or lint errors
        run: |
          VAL="${{ needs.validate-openapi.outputs.validation_has_errors }}"
          LINT="${{ needs.lint-openapi.outputs.lint_has_errors }}"

          echo "validation_has_errors=${VAL}"
          echo "lint_has_errors=${LINT}"

          if [ "${VAL}" = "true" ] || [ "${LINT}" = "true" ]; then
            echo "OpenAPI validation or lint errors detected. Failing PR."
            exit 1
          fi

          echo "No errors found. Success."
