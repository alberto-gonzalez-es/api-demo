name: openapi-pr-verify

on:
  pull_request:
    branches:
      - main
      - develop
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
    paths:
      - "api/rest/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-openapi-changes:
    runs-on: ubuntu-latest

    outputs:
      specs_json: ${{ steps.detect.outputs.specs_json }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Detect changed OpenAPI specs
        id: detect
        run: |
          set -e

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Base SHA: ${BASE_SHA}"
          echo "Head SHA: ${HEAD_SHA}"

          CHANGED_FILES=$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" || true)

          echo "Changed files:"
          echo "${CHANGED_FILES}"

          # Keep only OpenAPI files under api/rest/**/openapi.yml|yaml
          SPECS=$(echo "${CHANGED_FILES}" \
            | grep -E '^api/rest/.*/openapi\.ya?ml$' \
            | sort -u || true)

          if [ -z "${SPECS}" ]; then
            echo "No OpenAPI specs changed."
            printf 'specs_json=%s\n' "[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "OpenAPI specs to validate:"
          echo "${SPECS}"

          # Pretty JSON for logs
          SPECS_JSON_PRETTY=$(printf '%s\n' "${SPECS}" | jq -R . | jq -s .)
          echo "Specs JSON (pretty):"
          echo "${SPECS_JSON_PRETTY}"

          # Compact JSON for passing as output
          SPECS_JSON_COMPACT=$(printf '%s\n' "${SPECS}" | jq -R . | jq -s -c .)
          echo "Specs JSON (compact): ${SPECS_JSON_COMPACT}"

          printf 'specs_json=%s\n' "${SPECS_JSON_COMPACT}" >> "$GITHUB_OUTPUT"

  validate-openapi:
    needs: detect-openapi-changes
    if: needs.detect-openapi-changes.outputs.specs_json != '' && needs.detect-openapi-changes.outputs.specs_json != '[]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download openapi-generator-cli
        run: |
          curl -L \
            https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.17.0/openapi-generator-cli-7.17.0.jar \
            -o openapi-generator-cli.jar

      - name: Validate changed OpenAPI specs
        id: validate_specs
        env:
          SPECS_JSON: ${{ needs.detect-openapi-changes.outputs.specs_json }}
        continue-on-error: true
        run: |
          set -e

          echo "Specs JSON: ${SPECS_JSON}"

          REPORT_FILE="openapi-validation-report.md"
          : > "${REPORT_FILE}"

          HAS_ERRORS=0
          HAS_WARNINGS=0

          echo "## OpenAPI validation report" >> "${REPORT_FILE}"
          echo "" >> "${REPORT_FILE}"

          while read -r spec; do
            echo "Validating ${spec}..."
            OUTPUT_FILE="$(mktemp)"
            EXIT_CODE=0

            # Capture stdout + stderr
            if ! java -jar openapi-generator-cli.jar validate -i "${spec}" > "${OUTPUT_FILE}" 2>&1; then
              EXIT_CODE=$?
            fi

            echo "---- Output for ${spec} ----"
            cat "${OUTPUT_FILE}"

            # Extract warnings block: lines after 'Warnings:' until blank line or [info]/Error(s)
            WARNINGS_BLOCK=$(awk '
              /^Warnings[[:space:]]*:/ {flag=1; next}
              /^\[/ {flag=0}
              /^Error:/ {flag=0}
              /^Errors:/ {flag=0}
              /^$/ {if(flag==1){flag=0; next}}
              { if(flag) print }
            ' "${OUTPUT_FILE}")

            # Extract errors block: lines after 'Errors:' until blank line or "Error:" summary or [info]
            ERRORS_BLOCK=$(awk '
              /^Errors[[:space:]]*:/ {flag=1; next}
              /^\[/ {flag=0}
              /^Error:/ {flag=0}
              /^Warnings:/ {if(flag==0) next}
              /^$/ {if(flag==1){flag=0; next}}
              { if(flag) print }
            ' "${OUTPUT_FILE}")

            # Count bullet-style lines
            WARNINGS_COUNT=0
            if [ -n "${WARNINGS_BLOCK}" ]; then
              WARNINGS_COUNT=$(printf '%s\n' "${WARNINGS_BLOCK}" | grep -E '^[[:space:]]*-' | wc -l | tr -d ' ')
            fi

            ERRORS_COUNT=0
            if [ -n "${ERRORS_BLOCK}" ]; then
              ERRORS_COUNT=$(printf '%s\n' "${ERRORS_BLOCK}" | grep -E '^[[:space:]]*-' | wc -l | tr -d ' ')
            fi

            if [ "${WARNINGS_COUNT}" -gt 0 ]; then
              HAS_WARNINGS=1
            fi
            # Consider errors either by block or by non-zero exit code
            if [ "${ERRORS_COUNT}" -gt 0 ] || [ "${EXIT_CODE}" -ne 0 ]; then
              HAS_ERRORS=1
            fi

            echo "### \`${spec}\`" >> "${REPORT_FILE}"

            if [ "${ERRORS_COUNT}" -gt 0 ] || [ "${EXIT_CODE}" -ne 0 ]; then
              # ❌ Errors present
              if [ "${ERRORS_COUNT}" -eq 0 ]; then
                # No parsed bullets, fallback to 1 generic error
                ERRORS_COUNT=1
              fi
              echo "#### ❌ ${ERRORS_COUNT} error(s)" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"

              if [ -n "${ERRORS_BLOCK}" ]; then
                # Normalize bullet lines
                printf '%s\n' "${ERRORS_BLOCK}" \
                  | grep -E '^[[:space:]]*-' \
                  | sed -E 's/^[[:space:]]*-[[:space:]]*/- /' >> "${REPORT_FILE}"
              else
                # Fallback: dump full output if we couldn't parse the block
                echo '```text' >> "${REPORT_FILE}"
                cat "${OUTPUT_FILE}" >> "${REPORT_FILE}"
                echo '```' >> "${REPORT_FILE}"
              fi

              echo "" >> "${REPORT_FILE}"

            fi

            if [ "${WARNINGS_COUNT}" -gt 0 ]; then
              echo "#### ⚠️ ${WARNINGS_COUNT} warning(s)" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"

              printf '%s\n' "${WARNINGS_BLOCK}" \
                | grep -E '^[[:space:]]*-' \
                | sed -E 's/^[[:space:]]*-[[:space:]]*/- /' >> "${REPORT_FILE}"

              echo "" >> "${REPORT_FILE}"
            fi

            if [ "${ERRORS_COUNT}" -eq 0 ] && [ "${WARNINGS_COUNT}" -eq 0 ] && [ "${EXIT_CODE}" -eq 0 ]; then
              echo "- ✅ No issues found." >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
            fi

            rm -f "${OUTPUT_FILE}"
          done < <(echo "${SPECS_JSON}" | jq -r '.[]')

          if [ "${HAS_ERRORS}" -eq 0 ] && [ "${HAS_WARNINGS}" -eq 0 ]; then
            echo "All checked OpenAPI specs are valid ✅" >> "${REPORT_FILE}"
          fi

          echo "Validation summary:"
          cat "${REPORT_FILE}"

          if [ "${HAS_ERRORS}" -ne 0 ]; then
            echo "has_errors=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_errors=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment OpenAPI validation report on PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'openapi-validation-report.md';

            if (!fs.existsSync(path)) {
              core.info('No validation report file found, skipping comment.');
              return;
            }

            const body = fs.readFileSync(path, 'utf8');
            const prNumber = context.payload.pull_request.number;

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: prNumber,
              body,
            });

      - name: Fail if validation had errors
        if: steps.validate_specs.outputs.has_errors == 'true'
        run: |
          echo "OpenAPI validation found errors."
          exit 1
