name: openapi-pr-verify

on:
  pull_request:
    branches:
      - main
      - develop
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
    paths:
      - "api/rest/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-openapi-changes:
    runs-on: ubuntu-latest

    outputs:
      specs_json: ${{ steps.detect.outputs.specs_json }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Detect changed OpenAPI specs
        id: detect
        run: |
          set -e

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Base SHA: ${BASE_SHA}"
          echo "Head SHA: ${HEAD_SHA}"

          CHANGED_FILES=$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" || true)

          echo "Changed files:"
          echo "${CHANGED_FILES}"

          # Keep only OpenAPI files under api/rest/**/openapi.yml|yaml
          SPECS=$(echo "${CHANGED_FILES}" \
            | grep -E '^api/rest/.*/openapi\.ya?ml$' \
            | sort -u || true)

          if [ -z "${SPECS}" ]; then
            echo "No OpenAPI specs changed."
            printf 'specs_json=%s\n' "[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "OpenAPI specs to validate:"
          echo "${SPECS}"

          # Pretty JSON for logs
          SPECS_JSON_PRETTY=$(printf '%s\n' "${SPECS}" | jq -R . | jq -s .)
          echo "Specs JSON (pretty):"
          echo "${SPECS_JSON_PRETTY}"

          # Compact JSON for passing as output
          SPECS_JSON_COMPACT=$(printf '%s\n' "${SPECS}" | jq -R . | jq -s -c .)
          echo "Specs JSON (compact): ${SPECS_JSON_COMPACT}"

          printf 'specs_json=%s\n' "${SPECS_JSON_COMPACT}" >> "$GITHUB_OUTPUT"

  validate-openapi:
    needs: detect-openapi-changes
    if: needs.detect-openapi-changes.outputs.specs_json != '' && needs.detect-openapi-changes.outputs.specs_json != '[]'
    runs-on: ubuntu-latest

    outputs:
      validation_has_errors: ${{ steps.validate_specs.outputs.has_errors }}
      validation_report_b64: ${{ steps.validate_specs.outputs.report_b64 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download openapi-generator-cli
        run: |
          curl -L \
            https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.17.0/openapi-generator-cli-7.17.0.jar \
            -o openapi-generator-cli.jar

      - name: Validate changed OpenAPI specs
        id: validate_specs
        env:
          SPECS_JSON: ${{ needs.detect-openapi-changes.outputs.specs_json }}
        run: |
          set -e

          echo "Specs JSON: ${SPECS_JSON}"

          REPORT_FILE="openapi-validation-report.md"
          : > "${REPORT_FILE}"

          HAS_ERRORS=0
          HAS_WARNINGS=0

          echo "## OpenAPI validation report" >> "${REPORT_FILE}"
          echo "" >> "${REPORT_FILE}"

          # Helper: group multi-line bullets into single lines
          group_bullets() {
            awk '
              /^[ \t]*-/ {
                # New bullet starts
                if (current != "") {
                  print current
                }
                line=$0
                sub(/^[ \t]*/, "", line)       # trim leading spaces
                sub(/^-+[ \t]*/, "", line)     # remove leading "- " or "-- "
                current=line
                next
              }
              {
                # Continuation of current bullet: append text
                if (current != "") {
                  line=$0
                  sub(/^[ \t]*/, "", line)
                  current=current " " line
                }
              }
              END {
                if (current != "") {
                  print current
                }
              }
            '
          }

          while read -r spec; do
            echo "Validating ${spec}..."
            OUTPUT_FILE="$(mktemp)"
            EXIT_CODE=0

            # Capture stdout + stderr
            if ! java -jar openapi-generator-cli.jar validate -i "${spec}" > "${OUTPUT_FILE}" 2>&1; then
              EXIT_CODE=$?
            fi

            echo "---- Output for ${spec} ----"
            cat "${OUTPUT_FILE}"

            # Extract warnings block: lines after 'Warnings:' until blank/info/error
            WARNINGS_BLOCK=$(awk '
              /^Warnings[[:space:]]*:/ {flag=1; next}
              /^\[/ {flag=0}
              /^Error:/ {flag=0}
              /^Errors:/ {flag=0}
              /^$/ {if(flag==1){flag=0; next}}
              { if(flag) print }
            ' "${OUTPUT_FILE}")

            # Extract errors block: lines after 'Errors:' until blank/info/warnings/blank
            ERRORS_BLOCK=$(awk '
              /^Errors[[:space:]]*:/ {flag=1; next}
              /^Warnings[[:space:]]*:/ {flag=0}
              /^\[/ {flag=0}
              /^Error:/ {flag=0}
              /^$/ {if(flag==1){flag=0; next}}
              { if(flag) print }
            ' "${OUTPUT_FILE}")

            # Group multi-line bullets into single lines
            ERROR_LINES=""
            if [ -n "${ERRORS_BLOCK}" ]; then
              ERROR_LINES=$(printf '%s\n' "${ERRORS_BLOCK}" | group_bullets)
            fi

            WARNING_LINES=""
            if [ -n "${WARNINGS_BLOCK}" ]; then
              WARNING_LINES=$(printf '%s\n' "${WARNINGS_BLOCK}" | group_bullets)
            fi

            # Count lines
            ERRORS_COUNT=0
            if [ -n "${ERROR_LINES}" ]; then
              ERRORS_COUNT=$(printf '%s\n' "${ERROR_LINES}" | sed '/^$/d' | wc -l | tr -d ' ')
            fi

            WARNINGS_COUNT=0
            if [ -n "${WARNING_LINES}" ]; then
              WARNINGS_COUNT=$(printf '%s\n' "${WARNING_LINES}" | sed '/^$/d' | wc -l | tr -d ' ')
            fi

            if [ "${WARNINGS_COUNT}" -gt 0 ]; then
              HAS_WARNINGS=1
            fi
            # Consider errors either by parsed bullets or by non-zero exit
            if [ "${ERRORS_COUNT}" -gt 0 ] || [ "${EXIT_CODE}" -ne 0 ]; then
              HAS_ERRORS=1
            fi

            echo "### \`${spec}\`" >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"

            if [ "${ERRORS_COUNT}" > 0 ] || [ "${EXIT_CODE}" -ne 0 ]; then
              if [ "${ERRORS_COUNT}" -eq 0 ]; then
                ERRORS_COUNT=1
              fi

              echo "#### ❌ ${ERRORS_COUNT} error(s)" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"

              if [ -n "${ERROR_LINES}" ]; then
                while IFS= read -r line; do
                  [ -z "${line}" ] && continue
                  echo "- ${line}" >> "${REPORT_FILE}"
                done <<< "${ERROR_LINES}"
              else
                echo '```text' >> "${REPORT_FILE}"
                cat "${OUTPUT_FILE}" >> "${REPORT_FILE}"
                echo '```' >> "${REPORT_FILE}"
              fi

              echo "" >> "${REPORT_FILE}"
            fi

            if [ "${WARNINGS_COUNT}" -gt 0 ]; then
              echo "#### ⚠️ ${WARNINGS_COUNT} warning(s)" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"

              while IFS= read -r line; do
                [ -z "${line}" ] && continue
                echo "- ${line}" >> "${REPORT_FILE}"
              done <<< "${WARNING_LINES}"

              echo "" >> "${REPORT_FILE}"
            fi

            if [ "${ERRORS_COUNT}" -eq 0 ] && [ "${WARNINGS_COUNT}" -eq 0 ] && [ "${EXIT_CODE}" -eq 0 ]; then
              echo "- ✅ No issues found." >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE"`
            fi

            rm -f "${OUTPUT_FILE}"
          done <<< "$(echo "${SPECS_JSON}" | jq -r '.[]')"

          if [ "${HAS_ERRORS}" -eq 0 ] && [ "${HAS_WARNINGS}" -eq 0 ]; then
            echo "All checked OpenAPI specs are valid ✅" >> "${REPORT_FILE}"
          fi

          echo "Validation summary:"
          cat "${REPORT_FILE}"

          # Encode report and expose outputs
          REPORT_B64=$(base64 -w0 "${REPORT_FILE}")
          if [ "${HAS_ERRORS}" -ne 0 ]; then
            echo "has_errors=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_errors=false" >> "$GITHUB_OUTPUT"
          fi
          echo "report_b64=${REPORT_B64}" >> "$GITHUB_OUTPUT"

  lint-openapi:
    needs: detect-openapi-changes
    if: needs.detect-openapi-changes.outputs.specs_json != '' && needs.detect-openapi-changes.outputs.specs_json != '[]'
    runs-on: ubuntu-latest

    outputs:
      lint_has_errors: ${{ steps.lint_specs.outputs.has_errors }}
      lint_report_b64: ${{ steps.lint_specs.outputs.report_b64 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install Spectral CLI
        run: |
          npm install -g @stoplight/spectral-cli

      - name: Create Spectral ruleset extending spectral:oas
        run: |
          cat > .spectral.yaml << 'EOF'
          extends: "spectral:oas"
          EOF
          echo "Created .spectral.yaml:"
          cat .spectral.yaml

      - name: Lint changed OpenAPI specs with Spectral
        id: lint_specs
        env:
          SPECS_JSON: ${{ needs.detect-openapi-changes.outputs.specs_json }}
        run: |
          set -e

          echo "Specs JSON: ${SPECS_JSON}"

          REPORT_FILE="openapi-lint-report.md"
          : > "${REPORT_FILE}"

          HAS_ERRORS=0

          echo "## OpenAPI lint report (Spectral)" >> "${REPORT_FILE}"
          echo "" >> "${REPORT_FILE}"

          while read -r spec; do
            echo "Linting ${spec} with Spectral..."

            RESULTS_JSON=$(spectral lint "${spec}" -f json -r .spectral.yaml || true)

            if [ -z "${RESULTS_JSON}" ] || ! echo "${RESULTS_JSON}" | jq empty >/dev/null 2>&1; then
              echo "No lint results for ${spec}."
              continue
            fi

            ERRORS_JSON=$(echo "${RESULTS_JSON}" | jq '[.[] | select(.severity == 0)]')
            WARNINGS_JSON=$(echo "${RESULTS_JSON}" | jq '[.[] | select(.severity == 1)]')

            ERRORS_COUNT=$(echo "${ERRORS_JSON}" | jq 'length')
            WARNINGS_COUNT=$(echo "${WARNINGS_JSON}" | jq 'length')

            if [ "${ERRORS_COUNT}" -gt 0 ] || [ "${WARNINGS_COUNT}" -gt 0 ]; then
              echo "### \`${spec}\`" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
            fi

            if [ "${ERRORS_COUNT}" -gt 0 ]; then
              HAS_ERRORS=1
              echo "#### ❌ ${ERRORS_COUNT} lint error(s)" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"

              echo "${ERRORS_JSON}" | jq -r '.[] | "- \(.message) (code: \(.code)) at `\(.path | join("."))`"' >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
            fi

            if [ "${WARNINGS_COUNT}" -gt 0 ]; then
              echo "#### ⚠️ ${WARNINGS_COUNT} lint warning(s)" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"

              echo "${WARNINGS_JSON}" | jq -r '.[] | "- \(.message) (code: \(.code)) at `\(.path | join("."))`"' >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
            fi

            if [ "${ERRORS_COUNT}" -eq 0 ] && [ "${WARNINGS_COUNT}" -eq 0 ]; then
              echo "### \`${spec}\`" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
              echo "- ✅ No lint issues found." >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
            fi
          done <<< "$(echo "${SPECS_JSON}" | jq -r '.[]')"

          echo "Lint report:"
          cat "${REPORT_FILE}"

          REPORT_B64=$(base64 -w0 "${REPORT_FILE}")
          if [ "${HAS_ERRORS}" -ne 0 ]; then
            echo "has_errors=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_errors=false" >> "$GITHUB_OUTPUT"
          fi
          echo "report_b64=${REPORT_B64}" >> "$GITHUB_OUTPUT"

  breaking-changes-openapi:
    needs: detect-openapi-changes
    if: needs.detect-openapi-changes.outputs.specs_json != '' && needs.detect-openapi-changes.outputs.specs_json != '[]'
    runs-on: ubuntu-latest

    outputs:
      breaking_has_changes: ${{ steps.breaking_specs.outputs.has_breaking }}
      breaking_report_b64: ${{ steps.breaking_specs.outputs.report_b64 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pyyaml

      - name: Download openapi-diff CLI
        run: |
          curl -L \
            https://repo1.maven.org/maven2/org/openapitools/openapidiff/openapi-diff-cli/2.1.0/openapi-diff-cli-2.1.0-all.jar \
            -o openapi-diff-cli.jar

      - name: Detect breaking changes and version bump
        id: breaking_specs
        env:
          SPECS_JSON: ${{ needs.detect-openapi-changes.outputs.specs_json }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
        run: |
          set -e

          echo "Specs JSON: ${SPECS_JSON}"
          echo "Base SHA: ${BASE_SHA}"

          REPORT_FILE="openapi-breaking-changes-report.md"
          : > "${REPORT_FILE}"

          echo "## OpenAPI breaking changes report" >> "${REPORT_FILE}"
          echo "" >> "${REPORT_FILE}"

          HAS_BREAKING=0

          while read -r spec; do
            echo "Checking breaking changes and version bump for ${spec}..."

            # If spec did not exist in base, treat as new API and skip breaking/version checks
            if ! git cat-file -e "${BASE_SHA}:${spec}" 2>/dev/null; then
              echo "### \`${spec}\`" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
              echo "- ℹ️ Spec does not exist in base commit (new API). Skipping breaking changes and version checks." >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
              continue
            fi

            BASE_FILE="$(mktemp)"
            NEW_FILE="$(mktemp)"
            OUTPUT_FILE="$(mktemp)"

            git show "${BASE_SHA}:${spec}" > "${BASE_FILE}"
            cp "${spec}" "${NEW_FILE}"

            # 1) BREAKING CHANGES (openapi-diff)
            EXIT_CODE=0
            if ! java -jar openapi-diff-cli.jar --fail-on-incompatible "${BASE_FILE}" "${NEW_FILE}" > "${OUTPUT_FILE}" 2>&1; then
              EXIT_CODE=$?
            fi

            echo "### \`${spec}\`" >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"

            if [ "${EXIT_CODE}" -ne 0 ]; then
              HAS_BREAKING=1
              echo "#### ❌ Breaking changes detected" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
              echo '```text' >> "${REPORT_FILE}"
              cat "${OUTPUT_FILE}" >> "${REPORT_FILE}"
              echo '```' >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
            else
              echo "#### ✅ No breaking changes detected" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
            fi

            # 2) VERSION BUMP CHECK (info.version base vs new)
            VERSION_JSON=$(python3 - "$BASE_FILE" "$NEW_FILE" << 'EOF'
            import sys, json, re
            import yaml

            base_file, new_file = sys.argv[1], sys.argv[2]

            def parse_semver(s: str):
                if not s:
                    return None
                m = re.match(r'^(\d+)\.(\d+)\.(\d+)$', s.strip())
                if not m:
                    return None
                return tuple(map(int, m.groups()))

            with open(base_file, "r") as f:
                base = yaml.safe_load(f) or {}
            with open(new_file, "r") as f:
                new = yaml.safe_load(f) or {}

            base_v = (base.get("info") or {}).get("version")
            new_v = (new.get("info") or {}).get("version")

            base_sem = parse_semver(base_v)
            new_sem = parse_semver(new_v)

            result = {
                "base": base_v,
                "new": new_v,
                "bump": None,
                "valid": False,
                "reason": None
            }

            if base_sem is None or new_sem is None:
                result["reason"] = "Unable to parse semantic version (expected MAJOR.MINOR.PATCH)."
            else:
                bmaj, bmin, bpatch = base_sem
                nmaj, nmin, npatch = new_sem
                if (nmaj, nmin, npatch) == (bmaj, bmin, bpatch):
                    result["reason"] = "Version did not change."
                elif (nmaj, nmin, npatch) < (bmaj, bmin, bpatch):
                    result["reason"] = "Version decreased."
                else:
                    result["valid"] = True
                    if nmaj > bmaj:
                        result["bump"] = "major"
                    elif nmin > bmin:
                        result["bump"] = "minor"
                    elif npatch > bpatch:
                        result["bump"] = "patch"
                    else:
                        result["bump"] = "patch"

            print(json.dumps(result))
            EOF
            )

            BASE_VER=$(echo "${VERSION_JSON}" | jq -r '.base // "unknown"')
            NEW_VER=$(echo "${VERSION_JSON}" | jq -r '.new // "unknown"')
            BUMP_TYPE=$(echo "${VERSION_JSON}" | jq -r '.bump // empty')
            VERSION_VALID=$(echo "${VERSION_JSON}" | jq -r '.valid')
            VERSION_REASON=$(echo "${VERSION_JSON}" | jq -r '.reason // empty')

            echo "Base version: ${BASE_VER}"
            echo "New version: ${NEW_VER}"
            echo "Version bump type: ${BUMP_TYPE}"
            echo "Version valid: ${VERSION_VALID}"
            echo "Version reason: ${VERSION_REASON}"

            echo "#### Version check" >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
            echo "- Base version: \`${BASE_VER}\`" >> "${REPORT_FILE}"
            echo "- New version: \`${NEW_VER}\`" >> "${REPORT_FILE}"

            if [ "${VERSION_VALID}" = "true" ]; then
              echo "- ✅ Version increased with a *${BUMP_TYPE}* bump." >> "${REPORT_FILE}"
            else
              HAS_BREAKING=1
              echo "- ❌ Invalid version change: ${VERSION_REASON}" >> "${REPORT_FILE}"
            fi

            echo "" >> "${REPORT_FILE}"

            rm -f "${BASE_FILE}" "${NEW_FILE}" "${OUTPUT_FILE}"
          done <<< "$(echo "${SPECS_JSON}" | jq -r '.[]')"

          if [ "${HAS_BREAKING}" -eq 0 ]; then
            echo "No breaking changes or versioning issues detected across all specs." >> "${REPORT_FILE}"
          fi

          echo "Breaking changes and version summary:"
          cat "${REPORT_FILE}"

          REPORT_B64=$(base64 -w0 "${REPORT_FILE}")
          if [ "${HAS_BREAKING}" -ne 0 ]; then
            echo "has_breaking=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_breaking=false" >> "$GITHUB_OUTPUT"
          fi
          echo "report_b64=${REPORT_B64}" >> "$GITHUB_OUTPUT"

  summarize-openapi-checks:
    needs:
      - validate-openapi
      - lint-openapi
      - breaking-changes-openapi
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Build combined OpenAPI report
        run: |
          set -e

          VALIDATION_B64="${{ needs.validate-openapi.outputs.validation_report_b64 }}"
          LINT_B64="${{ needs.lint-openapi.outputs.lint_report_b64 }}"
          BREAKING_B64="${{ needs.breaking-changes-openapi.outputs.breaking_report_b64 }}"

          REPORT_FILE="openapi-combined-report.md"
          : > "${REPORT_FILE}"

          if [ -n "${VALIDATION_B64}" ]; then
            echo "${VALIDATION_B64}" | base64 -d >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
          fi

          if [ -n "${LINT_B64}" ]; then
            echo "${LINT_B64}" | base64 -d >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
          fi

          if [ -n "${BREAKING_B64}" ]; then
            echo "${BREAKING_B64}" | base64 -d >> "${REPORT_FILE}"
            echo "" >> "${REPORT_FILE}"
          fi

          cat "${REPORT_FILE}"

      - name: Comment combined OpenAPI report on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'openapi-combined-report.md';

            if (!fs.existsSync(path)) {
              core.info('No combined report file found, skipping comment.');
              return;
            }

            const body = fs.readFileSync(path, 'utf8');
            const prNumber = context.payload.pull_request.number;

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: prNumber,
              body,
            });

      - name: Final fail if there were errors
        run: |
          VALIDATION_ERRORS="${{ needs.validate-openapi.outputs.validation_has_errors }}"
          LINT_ERRORS="${{ needs.lint-openapi.outputs.lint_has_errors }}"
          BREAKING_CHANGES="${{ needs.breaking-changes-openapi.outputs.breaking_has_changes }}"

          echo "validation_has_errors=${VALIDATION_ERRORS}"
          echo "lint_has_errors=${LINT_ERRORS}"
          echo "breaking_has_changes=${BREAKING_CHANGES}"

          if [ "${VALIDATION_ERRORS}" = "true" ] || [ "${LINT_ERRORS}" = "true" ] || [ "${BREAKING_CHANGES}" = "true" ]; then
            echo "Validation, lint or breaking/version checks reported issues. Failing."
            exit 1
          fi

          echo "No validation errors, no lint errors and no breaking/version issues. Success."
