name: openapi-maven-deploy

on:
  pull_request:
    branches:
      - main
      - develop
    types:
      - closed
    paths:
      - 'api/rest/**'

permissions:
  contents: read
  packages: write

jobs:
  detect-changes:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    outputs:
      apis_json: ${{ steps.build_apis.outputs.apis_json }}

    steps:
      - name: Detect changed files under api/rest (base -> merge commit)
        id: detect_files
        uses: alberto-gonzalez-es/github-actions/actions/util/detect-changes@v1
        with:
          head_sha: ${{ github.event.pull_request.merge_commit_sha }}
          path_prefix: api/rest/

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: pip install pyyaml

      - name: Build APIs JSON from changed specs
        id: build_apis
        env:
          FILES_JSON: ${{ steps.detect_files.outputs.files_json }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          python << 'PY'
          import os, json, pathlib, sys
          import yaml

          files_json = os.environ["FILES_JSON"]
          base_branch = os.environ["BASE_BRANCH"]

          try:
            files = json.loads(files_json)
          except json.JSONDecodeError as e:
            print(f"[ERROR] Unable to parse FILES_JSON: {e}", file=sys.stderr)
            sys.exit(1)

          apis = []
          for f in files:
              # We want paths like api/rest/<API_NAME>/openapi.yml|yaml
              if not (f.endswith("openapi.yml") or f.endswith("openapi.yaml")):
                  continue

              parts = f.split("/")
              if len(parts) < 4:
                  continue
              api_name = parts[2]  # api/rest/<api_name>/...

              spec_path = pathlib.Path(f)
              if not spec_path.is_file():
                  print(f"[WARN] Spec file not found: {spec_path}", file=sys.stderr)
                  continue

              data = yaml.safe_load(spec_path.read_text(encoding="utf-8"))
              info = data.get("info", {})
              base_version = info.get("version")
              if not base_version:
                  print(f"[WARN] info.version not found in {spec_path}", file=sys.stderr)
                  continue

              if base_branch == "main":
                  final_version = base_version
              elif base_branch == "develop":
                  final_version = f"{base_version}-SNAPSHOT"
              else:
                  final_version = f"{base_version}-BETA"

              apis.append({
                  "name": api_name,
                  "spec_path": f,
                  "base_version": base_version,
                  "final_version": final_version,
                  "branch": base_branch,
              })

          apis_json = json.dumps(apis)
          print("Detected APIs:", apis_json)

          github_output = os.environ.get("GITHUB_OUTPUT")
          if github_output:
              with open(github_output, "a", encoding="utf-8") as fh:
                  fh.write(f"apis_json={apis_json}\n")
          PY

  build-and-deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.apis_json != '' && needs.detect-changes.outputs.apis_json != '[]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          java-version: "25"
          distribution: "temurin"
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: pip install pystache

      - name: Generate POMs from Mustache and deploy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          APIS_JSON: ${{ needs.detect-changes.outputs.apis_json }}
        run: |
          python << 'PY'
          import os, json, pathlib, shutil, subprocess
          import pystache

          apis_json = os.environ["APIS_JSON"]
          apis = json.loads(apis_json)
          if not apis:
              print("Nothing to deploy.")
              raise SystemExit(0)

          group_id = "es.alberto.gonzalez.api"
          template_path = pathlib.Path(".github/workflows/template/api/rest/maven/pom.mustache")
          template = template_path.read_text(encoding="utf-8")
          renderer = pystache.Renderer()

          for api in apis:
              api_name = api["name"]
              spec_path = pathlib.Path(api["spec_path"])
              final_version = api["final_version"]

              out_dir = pathlib.Path("package/generated") / api_name
              resources_dir = out_dir / "src" / "main" / "resources"
              resources_dir.mkdir(parents=True, exist_ok=True)

              shutil.copy2(spec_path, resources_dir / "openapi.yml")

              pom_content = renderer.render(
                  template,
                  {
                      "groupId": group_id,
                      "artifactId": api_name,
                      "version": final_version,
                  },
              )
              (out_dir / "pom.xml").write_text(pom_content, encoding="utf-8")

              print(f"Generated POM for {api_name} with version {final_version}")
              print((out_dir / "pom.xml").read_text(encoding="utf-8"))

              subprocess.run(
                  [
                      "mvn",
                      "-DskipTests",
                      "-DaltDeploymentRepository=github::https://maven.pkg.github.com/alberto-gonzalez-es/api-demo",
                      "deploy",
                  ],
                  cwd=str(out_dir),
                  check=True,
              )
          PY
